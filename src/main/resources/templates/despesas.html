<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <th:block th:fragment="titulo">Despesas - AESTRON</th:block>
</head>
<body>
    <th:block th:fragment="content">

    <div class="content">
<div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-wallet2"></i> Despesas</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalDespesa">
                <i class="bi bi-plus-circle"></i> Nova Despesa
            </button>
        </div>
        
        <!-- Resumo -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card bg-danger text-white">
                    <div class="stat-label">Total Pago (Mês)</div>
                    <div class="stat-value" id="totalPagoMes">R$ 0,00</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card bg-warning text-white">
                    <div class="stat-label">A Pagar</div>
                    <div class="stat-value" id="totalPendente">R$ 0,00</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card bg-dark text-white">
                    <div class="stat-label">Total Anual</div>
                    <div class="stat-value" id="totalAnual">R$ 0,00</div>
                </div>
            </div>
        </div>
        
        <!-- Tabela de Despesas -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> Lista de Despesas
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Fornecedor</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaDespesas">
                            <tr>
                                <td colspan="7" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Modal Nova/Editar Despesa -->
        <div class="modal fade" id="modalDespesa" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nova Despesa</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formDespesa">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Descrição *</label>
                                    <input type="text" class="form-control" id="descricao" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Valor *</label>
                                    <input type="number" step="0.01" class="form-control" id="valor" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Data Pagamento *</label>
                                    <input type="date" class="form-control" id="dataPagamento" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Categoria *</label>
                                    <select class="form-select" id="categoria" required>
                                        <option value="DAS_MEI">DAS MEI</option>
                                        <option value="IMPOSTOS">Impostos e Taxas</option>
                                        <option value="FORNECEDORES">Fornecedores</option>
                                        <option value="EQUIPAMENTOS">Equipamentos</option>
                                        <option value="SOFTWARE_LICENCAS">Software e Licenças</option>
                                        <option value="INTERNET_TELEFONE">Internet e Telefone</option>
                                        <option value="MARKETING">Marketing</option>
                                        <option value="ESCRITORIO">Despesas de Escritório</option>
                                        <option value="ALUGUEL">Aluguel</option>
                                        <option value="ENERGIA">Energia Elétrica</option>
                                        <option value="COMBUSTIVEL">Combustível</option>
                                        <option value="MANUTENCAO">Manutenção</option>
                                        <option value="PESSOAL">Pessoal</option>
                                        <option value="OUTROS">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Forma de Pagamento *</label>
                                    <select class="form-select" id="formaPagamento" required>
                                        <option value="PIX">PIX</option>
                                        <option value="DINHEIRO">Dinheiro</option>
                                        <option value="CARTAO_CREDITO">Cartão de Crédito</option>
                                        <option value="CARTAO_DEBITO">Cartão de Débito</option>
                                        <option value="BOLETO">Boleto</option>
                                        <option value="TRANSFERENCIA">Transferência Bancária</option>
                                        <option value="DEBITO_AUTOMATICO">Débito Automático</option>
                                        <option value="OUTROS">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fornecedor</label>
                                    <input type="text" class="form-control" id="fornecedor">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nº Documento</label>
                                    <input type="text" class="form-control" id="numeroDocumento">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Observações</label>
                                    <textarea class="form-control" id="observacoes" rows="3"></textarea>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="pago">
                                        <label class="form-check-label" for="pago">Despesa já paga</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="recorrente">
                                        <label class="form-check-label" for="recorrente">Despesa recorrente</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarDespesa()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            async function carregarDespesas() {
                try {
                    const response = await fetch('/api/despesas');
                    const despesas = await response.json();
                    
                    const tbody = document.getElementById('tabelaDespesas');
                    tbody.innerHTML = '';
                    
                    if (despesas.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma despesa cadastrada</td></tr>';
                        return;
                    }
                    
                    despesas.forEach(despesa => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${formatarData(despesa.dataPagamento)}</td>
                            <td>
                                ${despesa.descricao}
                                ${despesa.recorrente ? '<span class="badge bg-info ms-2">Recorrente</span>' : ''}
                            </td>
                            <td>${despesa.fornecedor || '-'}</td>
                            <td><span class="badge bg-secondary">${despesa.categoria}</span></td>
                            <td>${formatarMoeda(despesa.valor)}</td>
                            <td>
                                ${despesa.pago ? 
                                    '<span class="badge bg-success">Pago</span>' : 
                                    '<span class="badge bg-warning">Pendente</span>'}
                            </td>
                            <td>
                                ${!despesa.pago ? 
                                    `<button class="btn btn-sm btn-success" onclick="marcarPago(${despesa.id})">
                                        <i class="bi bi-check"></i>
                                    </button>` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deletarDespesa(${despesa.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    atualizarResumo();
                } catch (error) {
                    console.error('Erro ao carregar despesas:', error);
                }
            }
            
            async function atualizarResumo() {
                try {
                    const [mensal, anual, pendentes] = await Promise.all([
                        fetch('/api/despesas/total/mensal').then(r => r.json()),
                        fetch('/api/despesas/total/anual').then(r => r.json()),
                        fetch('/api/despesas/pendentes').then(r => r.json())
                    ]);
                    
                    document.getElementById('totalPagoMes').textContent = formatarMoeda(mensal);
                    document.getElementById('totalAnual').textContent = formatarMoeda(anual);
                    
                    const totalPendente = pendentes.reduce((sum, d) => sum + d.valor, 0);
                    document.getElementById('totalPendente').textContent = formatarMoeda(totalPendente);
                } catch (error) {
                    console.error('Erro ao atualizar resumo:', error);
                }
            }
            
            async function salvarDespesa() {
                const despesa = {
                    descricao: document.getElementById('descricao').value,
                    valor: parseFloat(document.getElementById('valor').value),
                    dataPagamento: document.getElementById('dataPagamento').value,
                    categoria: document.getElementById('categoria').value,
                    formaPagamento: document.getElementById('formaPagamento').value,
                    fornecedor: document.getElementById('fornecedor').value,
                    numeroDocumento: document.getElementById('numeroDocumento').value,
                    observacoes: document.getElementById('observacoes').value,
                    pago: document.getElementById('pago').checked,
                    recorrente: document.getElementById('recorrente').checked
                };
                
                try {
                    await fetch('/api/despesas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(despesa)
                    });
                    
                    bootstrap.Modal.getInstance(document.getElementById('modalDespesa')).hide();
                    document.getElementById('formDespesa').reset();
                    carregarDespesas();
                    exibirMensagem('success', 'Despesa cadastrada com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao salvar despesa');
                }
            }
            
            async function marcarPago(id) {
                if (!confirm('Confirmar pagamento?')) return;
                
                try {
                    await fetch(`/api/despesas/${id}/marcar-pago`, { method: 'PATCH' });
                    carregarDespesas();
                    exibirMensagem('success', 'Despesa marcada como paga!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao marcar como paga');
                }
            }
            
            async function deletarDespesa(id) {
                if (!confirm('Deseja realmente excluir esta despesa?')) return;
                
                try {
                    await fetch(`/api/despesas/${id}`, { method: 'DELETE' });
                    carregarDespesas();
                    exibirMensagem('success', 'Despesa excluída com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao excluir despesa');
                }
            }
            
            document.addEventListener('DOMContentLoaded', carregarDespesas);
        </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }
        
        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }
        
        function exibirMensagem(tipo, mensagem) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
            alertDiv.innerHTML = `${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.querySelector('.content').insertBefore(alertDiv, document.querySelector('.content').firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
    </th:block>
</body>
</html>