<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <th:block th:fragment="titulo">Portfolio - AESTRON</th:block>
</head>
<body>
    <th:block th:fragment="content">

    <div class="content">
<div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-box-seam"></i> Portfolio de Produtos e Servi√ßos</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPortfolio">
                <i class="bi bi-plus-circle"></i> Novo Produto/Servi√ßo
            </button>
        </div>
        
        <!-- Resumo -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card bg-primary text-white">
                    <div class="stat-label">Total de Produtos</div>
                    <div class="stat-value" id="totalProdutos">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-success text-white">
                    <div class="stat-label">Produtos Ativos</div>
                    <div class="stat-value" id="produtosAtivos">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-warning text-white">
                    <div class="stat-label">Em Destaque</div>
                    <div class="stat-value" id="produtosDestaque">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-info text-white">
                    <div class="stat-label">Categorias</div>
                    <div class="stat-value" id="totalCategorias">0</div>
                </div>
            </div>
        </div>
        
        <!-- Grid de Produtos -->
        <div id="gridPortfolio" class="row">
            <!-- Ser√° preenchido dinamicamente -->
        </div>
        
        <!-- Modal Novo/Editar Portfolio -->
        <div class="modal fade" id="modalPortfolio" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Novo Produto/Servi√ßo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formPortfolio">
                            <input type="hidden" id="portfolioId">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Nome do Produto/Servi√ßo *</label>
                                    <input type="text" class="form-control" id="nomePortfolio" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tipo *</label>
                                    <select class="form-select" id="tipoPortfolio" required>
                                        <option value="SOFTWARE_SOB_MEDIDA">Software Sob Medida</option>
                                        <option value="SOFTWARE_PRONTO">Software Pronto</option>
                                        <option value="EQUIPAMENTO_HARDWARE">Equipamento de Hardware</option>
                                        <option value="SERVICO_TI">Servi√ßo de TI</option>
                                        <option value="INFRAESTRUTURA">Infraestrutura e Redes</option>
                                        <option value="SEGURANCA">C√¢meras e Seguran√ßa</option>
                                        <option value="CONSULTORIA">Consultoria</option>
                                        <option value="MANUTENCAO">Manuten√ß√£o e Suporte</option>
                                        <option value="PACOTE">Pacote de Servi√ßos</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Descri√ß√£o</label>
                                    <textarea class="form-control" id="descricaoPortfolio" rows="3"></textarea>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Pre√ßo (R$)</label>
                                    <input type="number" step="0.01" class="form-control" id="precoPortfolio">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Custo de Produ√ß√£o (R$)</label>
                                    <input type="number" step="0.01" class="form-control" id="custoProducao">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Categoria</label>
                                    <input type="text" class="form-control" id="categoriaPortfolio" 
                                           placeholder="Ex: ERP, E-commerce, Infraestrutura">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Especifica√ß√µes T√©cnicas</label>
                                    <textarea class="form-control" id="especificacoes" rows="3"></textarea>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Benef√≠cios</label>
                                    <textarea class="form-control" id="beneficios" rows="3"></textarea>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tempo de Entrega (dias)</label>
                                    <input type="number" class="form-control" id="tempoEntrega">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Garantia (meses)</label>
                                    <input type="number" class="form-control" id="garantiaMeses">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Quantidade em Estoque</label>
                                    <input type="number" class="form-control" id="estoque">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="ativo" checked>
                                        <label class="form-check-label" for="ativo">Produto Ativo</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="destaque">
                                        <label class="form-check-label" for="destaque">Produto em Destaque</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="emDesenvolvimento" onchange="toggleCamposDesenvolvimento()">
                                        <label class="form-check-label" for="emDesenvolvimento">
                                            <i class="bi bi-code-slash"></i> Em Desenvolvimento
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Campos de Desenvolvimento (ocultos por padr√£o) -->
                                <div id="camposDesenvolvimento" style="display: none;">
                                    <div class="col-md-12 mb-3">
                                        <hr>
                                        <h6 class="text-primary"><i class="bi bi-gear-fill"></i> Informa√ß√µes de Desenvolvimento</h6>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Fase de Desenvolvimento *</label>
                                        <select class="form-select" id="faseDesenvolvimento">
                                            <option value="">Selecione a fase...</option>
                                            <option value="LEVANTAMENTO_REQUISITOS">üìã Levantamento de Requisitos</option>
                                            <option value="PROTOTIPACAO">üé® Prototipa√ß√£o / Design</option>
                                            <option value="DESENVOLVIMENTO_INICIAL">‚öôÔ∏è Desenvolvimento Inicial (0-30%)</option>
                                            <option value="DESENVOLVIMENTO_INTERMEDIARIO">üîß Desenvolvimento Intermedi√°rio (30-60%)</option>
                                            <option value="DESENVOLVIMENTO_AVANCADO">üöÄ Desenvolvimento Avan√ßado (60-90%)</option>
                                            <option value="TESTES">üß™ Testes e Ajustes</option>
                                            <option value="HOMOLOGACAO">‚úÖ Homologa√ß√£o com Cliente</option>
                                            <option value="FINALIZACAO">üèÅ Finaliza√ß√£o e Deploy</option>
                                            <option value="CONCLUIDO">‚úîÔ∏è Conclu√≠do</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Previs√£o de Entrega *</label>
                                        <input type="date" class="form-control" id="dataPrevisaoEntrega">
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">% Conclu√≠do</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="percentualConclusao" min="0" max="100" value="0">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-8 mb-3">
                                        <label class="form-label">Status da Documenta√ß√£o e Testes</label>
                                        <div class="d-flex gap-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="documentacaoAtualizada">
                                                <label class="form-check-label" for="documentacaoAtualizada">
                                                    üìÑ Documenta√ß√£o Atualizada
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="testesRealizados">
                                                <label class="form-check-label" for="testesRealizados">
                                                    üß™ Testes Realizados
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="homologacaoCliente">
                                                <label class="form-check-label" for="homologacaoCliente">
                                                    ‚úÖ Homologa√ß√£o Cliente
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Observa√ß√µes sobre o Desenvolvimento</label>
                                        <textarea class="form-control" id="observacoesDesenvolvimento" rows="3" 
                                                  placeholder="Ex: Aguardando aprova√ß√£o do layout, Pendente integra√ß√£o com API, etc."></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarPortfolio()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            async function carregarPortfolio() {
                try {
                    const response = await fetch('/api/portfolio');
                    const produtos = await response.json();
                    
                    const grid = document.getElementById('gridPortfolio');
                    grid.innerHTML = '';
                    
                    if (produtos.length === 0) {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info">Nenhum produto cadastrado ainda.</div></div>';
                        return;
                    }
                    
                    produtos.forEach(produto => {
                        const lucro = produto.preco && produto.custoProducao ? 
                                     (produto.preco - produto.custoProducao) : 0;
                        const margemLucro = produto.preco && produto.custoProducao ? 
                                           ((lucro / produto.preco) * 100).toFixed(1) : 0;
                        
                        // Determinar cor da barra de progresso do desenvolvimento
                        const progressoCor = produto.percentualConclusao >= 90 ? 'bg-success' :
                                           produto.percentualConclusao >= 60 ? 'bg-info' :
                                           produto.percentualConclusao >= 30 ? 'bg-warning' : 'bg-danger';
                        
                        const col = document.createElement('div');
                        col.className = 'col-md-4 mb-4';
                        col.innerHTML = `
                            <div class="card h-100 ${produto.destaque ? 'border-warning' : produto.emDesenvolvimento ? 'border-primary' : ''}">
                                <div class="position-absolute top-0 end-0 m-2">
                                    ${produto.destaque ? '<span class="badge bg-warning me-1">Destaque</span>' : ''}
                                    ${produto.emDesenvolvimento ? '<span class="badge bg-primary"><i class="bi bi-code-slash"></i> Em Desenvolvimento</span>' : ''}
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">
                                        ${produto.nome}
                                        ${!produto.ativo ? '<span class="badge bg-secondary">Inativo</span>' : ''}
                                    </h5>
                                    <p class="text-muted"><small><i class="bi bi-tag"></i> ${produto.tipo}</small></p>
                                    
                                    ${produto.emDesenvolvimento ? `
                                        <div class="alert alert-info p-2 mb-2">
                                            <strong><i class="bi bi-gear-fill"></i> ${produto.faseDesenvolvimento || 'Desenvolvimento'}</strong><br>
                                            <small>
                                                ${produto.dataPrevisaoEntrega ? 
                                                    `üìÖ Previs√£o: ${formatarData(produto.dataPrevisaoEntrega)}` : 
                                                    'Sem previs√£o definida'}
                                            </small>
                                            <div class="progress mt-2" style="height: 20px;">
                                                <div class="progress-bar ${progressoCor}" style="width: ${produto.percentualConclusao || 0}%">
                                                    ${produto.percentualConclusao || 0}%
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                ${produto.documentacaoAtualizada ? '<span class="badge bg-success me-1">üìÑ Doc OK</span>' : '<span class="badge bg-secondary me-1">üìÑ Doc Pendente</span>'}
                                                ${produto.testesRealizados ? '<span class="badge bg-success me-1">üß™ Testes OK</span>' : '<span class="badge bg-secondary me-1">üß™ Sem Testes</span>'}
                                                ${produto.homologacaoCliente ? '<span class="badge bg-success">‚úÖ Homologado</span>' : '<span class="badge bg-secondary">‚è≥ N√£o Homologado</span>'}
                                            </div>
                                            ${produto.observacoesDesenvolvimento ? 
                                                `<small class="text-muted d-block mt-2"><i class="bi bi-info-circle"></i> ${produto.observacoesDesenvolvimento}</small>` : ''}
                                        </div>
                                    ` : ''}
                                    
                                    ${produto.descricao ? `<p class="card-text">${produto.descricao}</p>` : ''}
                                    
                                    ${produto.preco ? `
                                        <div class="mb-2">
                                            <strong class="text-success">Pre√ßo: ${formatarMoeda(produto.preco)}</strong><br>
                                            ${produto.custoProducao ? `
                                                <small class="text-muted">
                                                    Custo: ${formatarMoeda(produto.custoProducao)} | 
                                                    Margem: ${margemLucro}%
                                                </small>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                    
                                    ${produto.tempoEntregaDias ? `<small><i class="bi bi-clock"></i> Entrega: ${produto.tempoEntregaDias} dias</small><br>` : ''}
                                    ${produto.garantiaMeses ? `<small><i class="bi bi-shield-check"></i> Garantia: ${produto.garantiaMeses} meses</small><br>` : ''}
                                    ${produto.quantidadeEstoque !== null ? `<small><i class="bi bi-boxes"></i> Estoque: ${produto.quantidadeEstoque}</small>` : ''}
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-sm btn-primary" onclick="editarPortfolio(${produto.id})">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    ${produto.ativo ? 
                                        `<button class="btn btn-sm btn-warning" onclick="desativarPortfolio(${produto.id})">
                                            <i class="bi bi-eye-slash"></i> Desativar
                                        </button>` :
                                        `<button class="btn btn-sm btn-success" onclick="ativarPortfolio(${produto.id})">
                                            <i class="bi bi-eye"></i> Ativar
                                        </button>`}
                                    <button class="btn btn-sm btn-danger" onclick="deletarPortfolio(${produto.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        grid.appendChild(col);
                    });
                    
                    atualizarResumoPortfolio(produtos);
                } catch (error) {
                    console.error('Erro ao carregar portfolio:', error);
                }
            }
            
            function atualizarResumoPortfolio(produtos) {
                const ativos = produtos.filter(p => p.ativo).length;
                const destaques = produtos.filter(p => p.destaque).length;
                const categorias = [...new Set(produtos.map(p => p.categoria).filter(c => c))].length;
                
                document.getElementById('totalProdutos').textContent = produtos.length;
                document.getElementById('produtosAtivos').textContent = ativos;
                document.getElementById('produtosDestaque').textContent = destaques;
                document.getElementById('totalCategorias').textContent = categorias;
            }
            
            function toggleCamposDesenvolvimento() {
                const checkbox = document.getElementById('emDesenvolvimento');
                const campos = document.getElementById('camposDesenvolvimento');
                const faseSelect = document.getElementById('faseDesenvolvimento');
                const dataPrevisao = document.getElementById('dataPrevisaoEntrega');
                
                if (checkbox.checked) {
                    campos.style.display = 'block';
                    faseSelect.required = true;
                    dataPrevisao.required = true;
                } else {
                    campos.style.display = 'none';
                    faseSelect.required = false;
                    dataPrevisao.required = false;
                }
            }
            
            async function salvarPortfolio() {
                const emDesenvolvimento = document.getElementById('emDesenvolvimento').checked;
                
                const portfolio = {
                    nome: document.getElementById('nomePortfolio').value,
                    tipo: document.getElementById('tipoPortfolio').value,
                    descricao: document.getElementById('descricaoPortfolio').value,
                    preco: document.getElementById('precoPortfolio').value ? 
                           parseFloat(document.getElementById('precoPortfolio').value) : null,
                    custoProducao: document.getElementById('custoProducao').value ? 
                                   parseFloat(document.getElementById('custoProducao').value) : null,
                    categoria: document.getElementById('categoriaPortfolio').value,
                    especificacoesTecnicas: document.getElementById('especificacoes').value,
                    beneficios: document.getElementById('beneficios').value,
                    tempoEntregaDias: document.getElementById('tempoEntrega').value ? 
                                     parseInt(document.getElementById('tempoEntrega').value) : null,
                    garantiaMeses: document.getElementById('garantiaMeses').value ? 
                                  parseInt(document.getElementById('garantiaMeses').value) : null,
                    quantidadeEstoque: document.getElementById('estoque').value ? 
                                      parseInt(document.getElementById('estoque').value) : null,
                    ativo: document.getElementById('ativo').checked,
                    destaque: document.getElementById('destaque').checked,
                    emDesenvolvimento: emDesenvolvimento
                };
                
                // Adicionar campos de desenvolvimento se marcado
                if (emDesenvolvimento) {
                    portfolio.faseDesenvolvimento = document.getElementById('faseDesenvolvimento').value;
                    portfolio.dataPrevisaoEntrega = document.getElementById('dataPrevisaoEntrega').value;
                    portfolio.percentualConclusao = document.getElementById('percentualConclusao').value ? 
                                                   parseInt(document.getElementById('percentualConclusao').value) : 0;
                    portfolio.documentacaoAtualizada = document.getElementById('documentacaoAtualizada').checked;
                    portfolio.testesRealizados = document.getElementById('testesRealizados').checked;
                    portfolio.homologacaoCliente = document.getElementById('homologacaoCliente').checked;
                    portfolio.observacoesDesenvolvimento = document.getElementById('observacoesDesenvolvimento').value;
                }
                
                try {
                    await fetch('/api/portfolio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(portfolio)
                    });
                    
                    bootstrap.Modal.getInstance(document.getElementById('modalPortfolio')).hide();
                    document.getElementById('formPortfolio').reset();
                    toggleCamposDesenvolvimento(); // Ocultar campos de desenvolvimento
                    carregarPortfolio();
                    exibirMensagem('success', 'Produto cadastrado com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao salvar produto');
                }
            }
            
            async function ativarPortfolio(id) {
                try {
                    await fetch(`/api/portfolio/${id}/ativar`, { method: 'PATCH' });
                    carregarPortfolio();
                    exibirMensagem('success', 'Produto ativado!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao ativar produto');
                }
            }
            
            async function desativarPortfolio(id) {
                try {
                    await fetch(`/api/portfolio/${id}/desativar`, { method: 'PATCH' });
                    carregarPortfolio();
                    exibirMensagem('success', 'Produto desativado!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao desativar produto');
                }
            }
            
            async function deletarPortfolio(id) {
                if (!confirm('Deseja realmente excluir este produto?')) return;
                
                try {
                    await fetch(`/api/portfolio/${id}`, { method: 'DELETE' });
                    carregarPortfolio();
                    exibirMensagem('success', 'Produto exclu√≠do com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao excluir produto');
                }
            }
            
            document.addEventListener('DOMContentLoaded', carregarPortfolio);
        </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }
        
        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }
        
        function exibirMensagem(tipo, mensagem) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-$${tipo} alert-dismissible fade show`;
            alertDiv.innerHTML = `$${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.querySelector('.content').insertBefore(alertDiv, document.querySelector('.content').firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
</body>
</html>

    </th:block>
</body>
</html>