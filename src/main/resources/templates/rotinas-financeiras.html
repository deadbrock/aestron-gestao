<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <th:block th:fragment="titulo">Rotinas Financeiras - AESTRON</th:block>
</head>
<body>
    <th:block th:fragment="content">
        <!-- Menu Horizontal do Meu Financeiro -->
        <div th:replace="~{fragments/meu-financeiro-nav :: navbar('rotinas')}"></div>
        
        <!-- Conte√∫do Principal -->
        <div class="mf-content mf-fade-in">
            <!-- Stats -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stat-card-pro" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);">
                        <h6>üìã Total Rotinas</h6>
                        <h2 id="totalRotinas">0</h2>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card-pro" style="background: linear-gradient(135deg, #0891b2 0%, #14b8a6 100%);">
                        <h6>‚úÖ Conclu√≠das Hoje</h6>
                        <h2 id="concluidasHoje">0</h2>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card-pro" style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);">
                        <h6>‚è∞ Pendentes</h6>
                        <h2 id="pendentes">0</h2>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card-pro" style="background: linear-gradient(135deg, #38bdf8 0%, #7dd3fc 100%);">
                        <h6>üìä Taxa Conclus√£o</h6>
                        <h2 id="taxaConclusao">0%</h2>
                    </div>
                </div>
            </div>

            <!-- A√ß√µes -->
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-modern btn-primary-gradient" data-bs-toggle="modal" data-bs-target="#modal">
                    <i class="bi bi-plus-circle-fill"></i> Nova Rotina
                </button>
            </div>

            <!-- Lista de Rotinas -->
            <div id="listaRotinas"></div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="modal">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border-radius: 15px 15px 0 0;">
                    <h5 class="modal-title"><i class="bi bi-plus-circle-fill"></i> Nova Rotina</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form">
                        <div class="mb-3"><input type="text" class="form-control" name="titulo" placeholder="T√≠tulo da Rotina" required style="border-radius: 10px;"></div>
                        <div class="mb-3"><textarea class="form-control" name="descricao" placeholder="Descri√ß√£o" rows="3" style="border-radius: 10px;"></textarea></div>
                        <div class="mb-3">
                            <select class="form-select" name="frequencia" required style="border-radius: 10px;">
                                <option value="DIARIA">üìÖ Di√°ria</option>
                                <option value="SEMANAL">üìÜ Semanal</option>
                                <option value="MENSAL">üóìÔ∏è Mensal</option>
                            </select>
                        </div>
                        <div class="mb-3"><input type="time" class="form-control" name="horario" style="border-radius: 10px;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-gradient btn-modern" onclick="salvar()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function carregar() {
            try {
                const res = await fetch('/api/meu-financeiro/rotinas');
                const data = await res.json();
                
                const total = data ? data.length : 0;
                const pendentes = data ? data.filter(r => !r.concluida).length : 0;
                const concluidas = total - pendentes;
                const taxa = total > 0 ? ((concluidas / total) * 100) : 0;
                
                document.getElementById('totalRotinas').textContent = total;
                document.getElementById('concluidasHoje').textContent = concluidas;
                document.getElementById('pendentes').textContent = pendentes;
                document.getElementById('taxaConclusao').textContent = taxa.toFixed(0) + '%';
                
                const container = document.getElementById('listaRotinas');
                if (data && data.length > 0) {
                    container.innerHTML = data.map(r => {
                        const icon = r.frequencia === 'DIARIA' ? 'üìÖ' : r.frequencia === 'SEMANAL' ? 'üìÜ' : 'üóìÔ∏è';
                        const statusIcon = r.concluida ? '‚úÖ' : '‚è∞';
                        const statusColor = r.concluida ? '#14b8a6' : '#06b6d4';
                        return `
                            <div class="card-modern mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="flex-grow-1">
                                            <h5 class="mb-1">${icon} ${r.titulo}</h5>
                                            <p class="text-muted mb-1">${r.descricao || 'Sem descri√ß√£o'}</p>
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> ${r.horario || 'Sem hor√°rio definido'} 
                                                | <span class="badge badge-modern" style="background: #1e40af;">${r.frequencia}</span>
                                            </small>
                                        </div>
                                        <div class="text-center ms-3">
                                            <div style="font-size: 2rem;">${statusIcon}</div>
                                            <small style="color: ${statusColor}; font-weight: 600;">${r.concluida ? 'Conclu√≠da' : 'Pendente'}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="card-modern"><div class="card-body text-center py-5 text-muted">Nenhuma rotina cadastrada</div></div>';
                }
            } catch (e) { console.error(e); }
        }
        
        async function salvar() {
            const fd = new FormData(document.getElementById('form'));
            const rotina = {
                titulo: fd.get('titulo'),
                descricao: fd.get('descricao'),
                frequencia: fd.get('frequencia'),
                horario: fd.get('horario'),
                concluida: false
            };
            await salvarComSeguranca('/api/meu-financeiro/rotinas', rotina, {
                modalId: 'modal',
                formId: 'form',
                callbackSucesso: carregar,
                mensagemSucesso: 'Rotina financeira cadastrada com sucesso!',
                mensagemErro: 'Erro ao salvar rotina. Verifique os dados e tente novamente.'
            });
        }
        
        document.addEventListener('DOMContentLoaded', carregar);
    </script>
    </th:block>
</body>
</html>
