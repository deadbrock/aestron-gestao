<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <th:block th:fragment="titulo">Leads - AESTRON</th:block>
</head>
<body>
    <th:block th:fragment="content">

    <div class="content">
<div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-people"></i> Gestão de Leads</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalLead">
                <i class="bi bi-plus-circle"></i> Novo Lead
            </button>
        </div>
        
        <!-- Métricas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card bg-primary text-white">
                    <div class="stat-label">Total de Leads</div>
                    <div class="stat-value" id="totalLeads">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-success text-white">
                    <div class="stat-label">Leads Novos</div>
                    <div class="stat-value" id="leadsNovos">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-warning text-white">
                    <div class="stat-label">Qualificados</div>
                    <div class="stat-value" id="leadsQualificados">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-info text-white">
                    <div class="stat-label">Taxa Conversão</div>
                    <div class="stat-value" id="taxaConversao">0%</div>
                </div>
            </div>
        </div>
        
        <!-- Funil de Vendas -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-funnel"></i> Funil de Vendas
            </div>
            <div class="card-body">
                <div class="row text-center" id="funnelVendas">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Status</label>
                        <select id="filtroStatus" class="form-select">
                            <option value="">Todos</option>
                            <option value="NOVO">Novo</option>
                            <option value="CONTATADO">Contatado</option>
                            <option value="QUALIFICADO">Qualificado</option>
                            <option value="PROPOSTA_ENVIADA">Proposta Enviada</option>
                            <option value="NEGOCIACAO">Negociação</option>
                            <option value="GANHO">Ganho</option>
                            <option value="PERDIDO">Perdido</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Origem</label>
                        <select id="filtroOrigem" class="form-select">
                            <option value="">Todas</option>
                            <option value="SITE">Site</option>
                            <option value="REDES_SOCIAIS">Redes Sociais</option>
                            <option value="INDICACAO">Indicação</option>
                            <option value="EMAIL_MARKETING">Email Marketing</option>
                            <option value="WHATSAPP">WhatsApp</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Interesse</label>
                        <select id="filtroInteresse" class="form-select">
                            <option value="">Todos</option>
                            <option value="SOFTWARE_SOB_MEDIDA">Software Sob Medida</option>
                            <option value="SOFTWARE_PRONTO">Software Pronto</option>
                            <option value="EQUIPAMENTOS">Equipamentos</option>
                            <option value="INFRAESTRUTURA">Infraestrutura</option>
                            <option value="SEGURANCA">Segurança</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="filtrarLeads()">
                            <i class="bi bi-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabela de Leads -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> Lista de Leads
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email/Telefone</th>
                                <th>Empresa</th>
                                <th>Origem</th>
                                <th>Interesse</th>
                                <th>Status</th>
                                <th>Pontuação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaLeads">
                            <tr>
                                <td colspan="8" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Modal Novo/Editar Lead -->
        <div class="modal fade" id="modalLead" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Novo Lead</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formLead">
                            <input type="hidden" id="leadId">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome *</label>
                                    <input type="text" class="form-control" id="nome" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="tel" class="form-control" id="telefone">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Empresa</label>
                                    <input type="text" class="form-control" id="empresa">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Cargo</label>
                                    <input type="text" class="form-control" id="cargo">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="status">
                                        <option value="NOVO">Novo</option>
                                        <option value="CONTATADO">Contatado</option>
                                        <option value="QUALIFICADO">Qualificado</option>
                                        <option value="PROPOSTA_ENVIADA">Proposta Enviada</option>
                                        <option value="NEGOCIACAO">Negociação</option>
                                        <option value="GANHO">Ganho</option>
                                        <option value="PERDIDO">Perdido</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Origem</label>
                                    <select class="form-select" id="origem">
                                        <option value="SITE">Site</option>
                                        <option value="REDES_SOCIAIS">Redes Sociais</option>
                                        <option value="INDICACAO">Indicação</option>
                                        <option value="EMAIL_MARKETING">Email Marketing</option>
                                        <option value="EVENTO">Evento</option>
                                        <option value="TELEFONE">Telefone</option>
                                        <option value="WHATSAPP">WhatsApp</option>
                                        <option value="OUTROS">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Interesse</label>
                                    <select class="form-select" id="interesse">
                                        <option value="SOFTWARE_SOB_MEDIDA">Software Sob Medida</option>
                                        <option value="SOFTWARE_PRONTO">Software Pronto</option>
                                        <option value="EQUIPAMENTOS">Equipamentos</option>
                                        <option value="INFRAESTRUTURA">Infraestrutura</option>
                                        <option value="SEGURANCA">Câmeras de Segurança</option>
                                        <option value="CONSULTORIA">Consultoria</option>
                                        <option value="MANUTENCAO">Manutenção</option>
                                        <option value="MULTIPLOS">Múltiplos Serviços</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Observações</label>
                                    <textarea class="form-control" id="observacoes" rows="4"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarLead()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            async function carregarLeads() {
                try {
                    const response = await fetch('/api/leads');
                    const leads = await response.json();
                    
                    const tbody = document.getElementById('tabelaLeads');
                    tbody.innerHTML = '';
                    
                    if (leads.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum lead cadastrado</td></tr>';
                        return;
                    }
                    
                    leads.forEach(lead => {
                        const statusClass = getStatusClass(lead.status);
                        const pontuacaoClass = lead.pontuacao >= 50 ? 'success' : lead.pontuacao >= 30 ? 'warning' : 'secondary';
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><strong>${lead.nome}</strong></td>
                            <td>
                                ${lead.email ? `<small><i class="bi bi-envelope"></i> ${lead.email}</small><br>` : ''}
                                ${lead.telefone ? `<small><i class="bi bi-telephone"></i> ${lead.telefone}</small>` : ''}
                            </td>
                            <td>${lead.empresa || '-'}</td>
                            <td><span class="badge bg-info">${lead.origem || '-'}</span></td>
                            <td><span class="badge bg-secondary">${lead.interesse || '-'}</span></td>
                            <td><span class="badge bg-${statusClass}">${lead.status}</span></td>
                            <td><span class="badge bg-${pontuacaoClass}">${lead.pontuacao} pts</span></td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="calcularPontuacao(${lead.id})" title="Recalcular Pontuação">
                                    <i class="bi bi-calculator"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletarLead(${lead.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    atualizarMetricas(leads);
                    atualizarFunil(leads);
                } catch (error) {
                    console.error('Erro ao carregar leads:', error);
                }
            }
            
            function getStatusClass(status) {
                const classes = {
                    'NOVO': 'primary',
                    'CONTATADO': 'info',
                    'QUALIFICADO': 'warning',
                    'PROPOSTA_ENVIADA': 'secondary',
                    'NEGOCIACAO': 'dark',
                    'GANHO': 'success',
                    'PERDIDO': 'danger',
                    'SEM_INTERESSE': 'secondary'
                };
                return classes[status] || 'secondary';
            }
            
            function atualizarMetricas(leads) {
                const novos = leads.filter(l => l.status === 'NOVO').length;
                const qualificados = leads.filter(l => l.status === 'QUALIFICADO').length;
                const ganhos = leads.filter(l => l.status === 'GANHO').length;
                
                document.getElementById('totalLeads').textContent = leads.length;
                document.getElementById('leadsNovos').textContent = novos;
                document.getElementById('leadsQualificados').textContent = qualificados;
                
                const taxa = leads.length > 0 ? (ganhos / leads.length * 100).toFixed(1) : 0;
                document.getElementById('taxaConversao').textContent = taxa + '%';
            }
            
            function atualizarFunil(leads) {
                const statusCount = {};
                const statusOrder = ['NOVO', 'CONTATADO', 'QUALIFICADO', 'PROPOSTA_ENVIADA', 'NEGOCIACAO', 'GANHO'];
                
                statusOrder.forEach(status => {
                    statusCount[status] = leads.filter(l => l.status === status).length;
                });
                
                const funnel = document.getElementById('funnelVendas');
                funnel.innerHTML = '';
                
                statusOrder.forEach(status => {
                    const count = statusCount[status];
                    const col = document.createElement('div');
                    col.className = 'col-md-2';
                    col.innerHTML = `
                        <div class="card bg-${getStatusClass(status)} text-white mb-2">
                            <div class="card-body text-center p-2">
                                <h3>${count}</h3>
                                <small>${status.replace(/_/g, ' ')}</small>
                            </div>
                        </div>
                    `;
                    funnel.appendChild(col);
                });
            }
            
            async function salvarLead() {
                const lead = {
                    nome: document.getElementById('nome').value,
                    email: document.getElementById('email').value,
                    telefone: document.getElementById('telefone').value,
                    empresa: document.getElementById('empresa').value,
                    cargo: document.getElementById('cargo').value,
                    status: document.getElementById('status').value,
                    origem: document.getElementById('origem').value,
                    interesse: document.getElementById('interesse').value,
                    observacoes: document.getElementById('observacoes').value
                };
                
                try {
                    await fetch('/api/leads', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(lead)
                    });
                    
                    bootstrap.Modal.getInstance(document.getElementById('modalLead')).hide();
                    document.getElementById('formLead').reset();
                    carregarLeads();
                    exibirMensagem('success', 'Lead cadastrado com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao salvar lead');
                }
            }
            
            async function calcularPontuacao(id) {
                try {
                    await fetch(`/api/leads/${id}/calcular-pontuacao`, { method: 'PATCH' });
                    carregarLeads();
                    exibirMensagem('success', 'Pontuação recalculada!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao calcular pontuação');
                }
            }
            
            async function deletarLead(id) {
                if (!confirm('Deseja realmente excluir este lead?')) return;
                
                try {
                    await fetch(`/api/leads/${id}`, { method: 'DELETE' });
                    carregarLeads();
                    exibirMensagem('success', 'Lead excluído com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao excluir lead');
                }
            }
            
            document.addEventListener('DOMContentLoaded', carregarLeads);
        </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }
        
        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }
        
        function exibirMensagem(tipo, mensagem) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-$${tipo} alert-dismissible fade show`;
            alertDiv.innerHTML = `$${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.querySelector('.content').insertBefore(alertDiv, document.querySelector('.content').firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
</body>
</html>

    </th:block>
</body>
</html>