<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <th:block th:fragment="titulo">Campanhas - AESTRON</th:block>
</head>
<body>
    <th:block th:fragment="content">

    <div class="content">
<div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-megaphone"></i> Campanhas de Marketing</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCampanha">
                <i class="bi bi-plus-circle"></i> Nova Campanha
            </button>
        </div>
        
        <!-- Resumo -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card bg-primary text-white">
                    <div class="stat-label">Total Campanhas</div>
                    <div class="stat-value" id="totalCampanhas">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-success text-white">
                    <div class="stat-label">Ativas</div>
                    <div class="stat-value" id="campanhasAtivas">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-warning text-white">
                    <div class="stat-label">Total Leads Gerados</div>
                    <div class="stat-value" id="totalLeadsGerados">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-info text-white">
                    <div class="stat-label">Orçamento Total</div>
                    <div class="stat-value" id="orcamentoTotal">R$ 0,00</div>
                </div>
            </div>
        </div>
        
        <!-- Grid de Campanhas -->
        <div id="gridCampanhas" class="row">
            <!-- Será preenchido dinamicamente -->
        </div>
        
        <!-- Modal Nova/Editar Campanha -->
        <div class="modal fade" id="modalCampanha" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nova Campanha</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formCampanha">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Nome da Campanha *</label>
                                    <input type="text" class="form-control" id="nomeCampanha" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tipo *</label>
                                    <select class="form-select" id="tipoCampanha" required>
                                        <option value="EMAIL_MARKETING">Email Marketing</option>
                                        <option value="REDES_SOCIAIS">Redes Sociais</option>
                                        <option value="GOOGLE_ADS">Google Ads</option>
                                        <option value="FACEBOOK_ADS">Facebook Ads</option>
                                        <option value="WHATSAPP">WhatsApp</option>
                                        <option value="EVENTO">Evento</option>
                                        <option value="WEBINAR">Webinar</option>
                                        <option value="CONTEUDO">Marketing de Conteúdo</option>
                                        <option value="INDICACAO">Programa de Indicação</option>
                                        <option value="HIBRIDA">Campanha Híbrida</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Descrição</label>
                                    <textarea class="form-control" id="descricaoCampanha" rows="3"></textarea>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Data Início *</label>
                                    <input type="date" class="form-control" id="dataInicio" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Data Fim</label>
                                    <input type="date" class="form-control" id="dataFim">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="statusCampanha">
                                        <option value="PLANEJAMENTO">Planejamento</option>
                                        <option value="ATIVA">Ativa</option>
                                        <option value="PAUSADA">Pausada</option>
                                        <option value="FINALIZADA">Finalizada</option>
                                        <option value="CANCELADA">Cancelada</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Orçamento (R$)</label>
                                    <input type="number" step="0.01" class="form-control" id="orcamento">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Meta de Leads</label>
                                    <input type="number" class="form-control" id="metaLeads">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Meta de Conversão (%)</label>
                                    <input type="number" class="form-control" id="metaConversao">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Canais Utilizados</label>
                                    <textarea class="form-control" id="canais" rows="2" 
                                              placeholder="Ex: Facebook, Instagram, Google Ads"></textarea>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Público-Alvo</label>
                                    <textarea class="form-control" id="publicoAlvo" rows="2" 
                                              placeholder="Ex: Pequenas empresas, idade 25-45 anos, região Sul"></textarea>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Mensagem Principal</label>
                                    <textarea class="form-control" id="mensagemPrincipal" rows="2" 
                                              placeholder="Ex: Transforme sua gestão com nossa solução"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarCampanha()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            async function carregarCampanhas() {
                try {
                    const response = await fetch('/api/campanhas');
                    const campanhas = await response.json();
                    
                    const grid = document.getElementById('gridCampanhas');
                    grid.innerHTML = '';
                    
                    if (campanhas.length === 0) {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info">Nenhuma campanha cadastrada ainda.</div></div>';
                        return;
                    }
                    
                    campanhas.forEach(campanha => {
                        const statusClass = getStatusCampanhaClass(campanha.status);
                        const progresso = campanha.orcamento && campanha.gastoAtual ? 
                                         ((campanha.gastoAtual / campanha.orcamento) * 100).toFixed(1) : 0;
                        
                        const col = document.createElement('div');
                        col.className = 'col-md-6 mb-4';
                        col.innerHTML = `
                            <div class="card h-100">
                                <div class="card-header bg-${statusClass} text-white">
                                    <h5 class="mb-0">${campanha.nome}</h5>
                                    <small><i class="bi bi-tag"></i> ${campanha.tipo}</small>
                                </div>
                                <div class="card-body">
                                    ${campanha.descricao ? `<p class="card-text">${campanha.descricao}</p>` : ''}
                                    
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Período</small><br>
                                            <strong>${formatarData(campanha.dataInicio)}</strong>
                                            ${campanha.dataFim ? ` até ${formatarData(campanha.dataFim)}` : ''}
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Status</small><br>
                                            <span class="badge bg-${statusClass}">${campanha.status}</span>
                                        </div>
                                    </div>
                                    
                                    ${campanha.orcamento ? `
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <small>Orçamento</small>
                                                <small>${formatarMoeda(campanha.gastoAtual || 0)} / ${formatarMoeda(campanha.orcamento)}</small>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar ${progresso > 90 ? 'bg-danger' : progresso > 70 ? 'bg-warning' : 'bg-success'}" 
                                                     style="width: ${Math.min(progresso, 100)}%">
                                                    ${progresso}%
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <h4 class="text-primary">${campanha.leads ? campanha.leads.length : 0}</h4>
                                            <small>Leads</small>
                                        </div>
                                        <div class="col-4">
                                            <h4 class="text-success">${campanha.metaLeads || '-'}</h4>
                                            <small>Meta Leads</small>
                                        </div>
                                        <div class="col-4">
                                            <h4 class="text-warning">${campanha.metaConversao || '-'}%</h4>
                                            <small>Meta Conv.</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    ${campanha.status === 'PLANEJAMENTO' || campanha.status === 'PAUSADA' ? 
                                        `<button class="btn btn-sm btn-success" onclick="ativarCampanha(${campanha.id})">
                                            <i class="bi bi-play"></i> Ativar
                                        </button>` : ''}
                                    ${campanha.status === 'ATIVA' ? 
                                        `<button class="btn btn-sm btn-warning" onclick="pausarCampanha(${campanha.id})">
                                            <i class="bi bi-pause"></i> Pausar
                                        </button>` : ''}
                                    ${campanha.status === 'ATIVA' || campanha.status === 'PAUSADA' ? 
                                        `<button class="btn btn-sm btn-secondary" onclick="finalizarCampanha(${campanha.id})">
                                            <i class="bi bi-check-circle"></i> Finalizar
                                        </button>` : ''}
                                    <button class="btn btn-sm btn-danger" onclick="deletarCampanha(${campanha.id})">
                                        <i class="bi bi-trash"></i> Excluir
                                    </button>
                                </div>
                            </div>
                        `;
                        grid.appendChild(col);
                    });
                    
                    atualizarResumoCampanhas(campanhas);
                } catch (error) {
                    console.error('Erro ao carregar campanhas:', error);
                }
            }
            
            function getStatusCampanhaClass(status) {
                const classes = {
                    'PLANEJAMENTO': 'secondary',
                    'ATIVA': 'success',
                    'PAUSADA': 'warning',
                    'FINALIZADA': 'primary',
                    'CANCELADA': 'danger'
                };
                return classes[status] || 'secondary';
            }
            
            function atualizarResumoCampanhas(campanhas) {
                const ativas = campanhas.filter(c => c.status === 'ATIVA').length;
                const totalLeads = campanhas.reduce((sum, c) => sum + (c.leads ? c.leads.length : 0), 0);
                const orcamentoTotal = campanhas.reduce((sum, c) => sum + (c.orcamento || 0), 0);
                
                document.getElementById('totalCampanhas').textContent = campanhas.length;
                document.getElementById('campanhasAtivas').textContent = ativas;
                document.getElementById('totalLeadsGerados').textContent = totalLeads;
                document.getElementById('orcamentoTotal').textContent = formatarMoeda(orcamentoTotal);
            }
            
            async function salvarCampanha() {
                const campanha = {
                    nome: document.getElementById('nomeCampanha').value,
                    tipo: document.getElementById('tipoCampanha').value,
                    descricao: document.getElementById('descricaoCampanha').value,
                    dataInicio: document.getElementById('dataInicio').value,
                    dataFim: document.getElementById('dataFim').value || null,
                    status: document.getElementById('statusCampanha').value,
                    orcamento: document.getElementById('orcamento').value ? 
                              parseFloat(document.getElementById('orcamento').value) : null,
                    metaLeads: document.getElementById('metaLeads').value ? 
                              parseInt(document.getElementById('metaLeads').value) : null,
                    metaConversao: document.getElementById('metaConversao').value ? 
                                  parseInt(document.getElementById('metaConversao').value) : null,
                    canaisUtilizados: document.getElementById('canais').value,
                    publicoAlvo: document.getElementById('publicoAlvo').value,
                    mensagemPrincipal: document.getElementById('mensagemPrincipal').value,
                    gastoAtual: 0
                };
                
                try {
                    await fetch('/api/campanhas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(campanha)
                    });
                    
                    bootstrap.Modal.getInstance(document.getElementById('modalCampanha')).hide();
                    document.getElementById('formCampanha').reset();
                    carregarCampanhas();
                    exibirMensagem('success', 'Campanha cadastrada com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao salvar campanha');
                }
            }
            
            async function ativarCampanha(id) {
                try {
                    await fetch(`/api/campanhas/${id}/ativar`, { method: 'PATCH' });
                    carregarCampanhas();
                    exibirMensagem('success', 'Campanha ativada!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao ativar campanha');
                }
            }
            
            async function pausarCampanha(id) {
                try {
                    await fetch(`/api/campanhas/${id}/pausar`, { method: 'PATCH' });
                    carregarCampanhas();
                    exibirMensagem('success', 'Campanha pausada!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao pausar campanha');
                }
            }
            
            async function finalizarCampanha(id) {
                if (!confirm('Confirma finalização da campanha?')) return;
                
                try {
                    await fetch(`/api/campanhas/${id}/finalizar`, { method: 'PATCH' });
                    carregarCampanhas();
                    exibirMensagem('success', 'Campanha finalizada!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao finalizar campanha');
                }
            }
            
            async function deletarCampanha(id) {
                if (!confirm('Deseja realmente excluir esta campanha?')) return;
                
                try {
                    await fetch(`/api/campanhas/${id}`, { method: 'DELETE' });
                    carregarCampanhas();
                    exibirMensagem('success', 'Campanha excluída com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao excluir campanha');
                }
            }
            
            document.addEventListener('DOMContentLoaded', carregarCampanhas);
        </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }
        
        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }
        
        function exibirMensagem(tipo, mensagem) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-$${tipo} alert-dismissible fade show`;
            alertDiv.innerHTML = `$${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.querySelector('.content').insertBefore(alertDiv, document.querySelector('.content').firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
</body>
</html>

    </th:block>
</body>
</html>