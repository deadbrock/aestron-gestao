<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <th:block th:fragment="titulo">Receitas - AESTRON</th:block>
</head>
<body>
    <th:block th:fragment="content">

    <div class="content">
<div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-cash-coin"></i> Receitas</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalReceita">
                <i class="bi bi-plus-circle"></i> Nova Receita
            </button>
        </div>
        
        <!-- Resumo -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card bg-success text-white">
                    <div class="stat-label">Total Recebido (Mês)</div>
                    <div class="stat-value" id="totalRecebidoMes">R$ 0,00</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card bg-info text-white">
                    <div class="stat-label">A Receber</div>
                    <div class="stat-value" id="totalPendente">R$ 0,00</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card bg-primary text-white">
                    <div class="stat-label">Total Anual</div>
                    <div class="stat-value" id="totalAnual">R$ 0,00</div>
                </div>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Categoria</label>
                        <select id="filtroCategoria" class="form-select">
                            <option value="">Todas</option>
                            <option value="SOFTWARE_SOB_MEDIDA">Software Sob Medida</option>
                            <option value="SOFTWARE_PRONTO">Software Pronto</option>
                            <option value="EQUIPAMENTOS_INFORMATICA">Equipamentos</option>
                            <option value="SERVICOS_TI">Serviços de TI</option>
                            <option value="INFRAESTRUTURA_REDES">Infraestrutura</option>
                            <option value="CAMERAS_SEGURANCA">Câmeras</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Status</label>
                        <select id="filtroStatus" class="form-select">
                            <option value="">Todos</option>
                            <option value="recebido">Recebido</option>
                            <option value="pendente">Pendente</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Data Início</label>
                        <input type="date" id="filtroDataInicio" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Data Fim</label>
                        <input type="date" id="filtroDataFim" class="form-control">
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="filtrarReceitas()">
                    <i class="bi bi-filter"></i> Filtrar
                </button>
            </div>
        </div>
        
        <!-- Tabela de Receitas -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> Lista de Receitas
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Cliente</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaReceitas">
                            <tr>
                                <td colspan="7" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Modal Nova/Editar Receita -->
        <div class="modal fade" id="modalReceita" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nova Receita</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formReceita">
                            <input type="hidden" id="receitaId">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Descrição *</label>
                                    <input type="text" class="form-control" id="descricao" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Valor *</label>
                                    <input type="number" step="0.01" class="form-control" id="valor" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Data Recebimento *</label>
                                    <input type="date" class="form-control" id="dataRecebimento" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Categoria *</label>
                                    <select class="form-select" id="categoria" required>
                                        <option value="SOFTWARE_SOB_MEDIDA">Software Sob Medida</option>
                                        <option value="SOFTWARE_PRONTO">Software Pronto</option>
                                        <option value="EQUIPAMENTOS_INFORMATICA">Equipamentos de Informática</option>
                                        <option value="SERVICOS_TI">Serviços de TI</option>
                                        <option value="INFRAESTRUTURA_REDES">Infraestrutura e Redes</option>
                                        <option value="CAMERAS_SEGURANCA">Câmeras de Segurança</option>
                                        <option value="CONSULTORIA">Consultoria</option>
                                        <option value="MANUTENCAO">Manutenção</option>
                                        <option value="OUTROS">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Forma de Pagamento *</label>
                                    <select class="form-select" id="formaPagamento" required>
                                        <option value="PIX">PIX</option>
                                        <option value="DINHEIRO">Dinheiro</option>
                                        <option value="CARTAO_CREDITO">Cartão de Crédito</option>
                                        <option value="CARTAO_DEBITO">Cartão de Débito</option>
                                        <option value="BOLETO">Boleto</option>
                                        <option value="TRANSFERENCIA">Transferência Bancária</option>
                                        <option value="OUTROS">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Cliente</label>
                                    <input type="text" class="form-control" id="cliente">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nº Nota Fiscal</label>
                                    <input type="text" class="form-control" id="numeroNotaFiscal">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Observações</label>
                                    <textarea class="form-control" id="observacoes" rows="3"></textarea>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="recebido">
                                        <label class="form-check-label" for="recebido">
                                            Receita já recebida
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarReceita()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            async function carregarReceitas() {
                try {
                    const response = await fetch('/api/receitas');
                    const receitas = await response.json();
                    
                    const tbody = document.getElementById('tabelaReceitas');
                    tbody.innerHTML = '';
                    
                    if (receitas.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma receita cadastrada</td></tr>';
                        return;
                    }
                    
                    receitas.forEach(receita => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${formatarData(receita.dataRecebimento)}</td>
                            <td>${receita.descricao}</td>
                            <td>${receita.cliente || '-'}</td>
                            <td><span class="badge bg-info">${receita.categoria}</span></td>
                            <td>${formatarMoeda(receita.valor)}</td>
                            <td>
                                ${receita.recebido ? 
                                    '<span class="badge bg-success">Recebido</span>' : 
                                    '<span class="badge bg-warning">Pendente</span>'}
                            </td>
                            <td>
                                ${!receita.recebido ? 
                                    `<button class="btn btn-sm btn-success" onclick="marcarRecebido(${receita.id})">
                                        <i class="bi bi-check"></i>
                                    </button>` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deletarReceita(${receita.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    atualizarResumo();
                } catch (error) {
                    console.error('Erro ao carregar receitas:', error);
                }
            }
            
            async function atualizarResumo() {
                try {
                    const [mensal, anual, pendentes] = await Promise.all([
                        fetch('/api/receitas/total/mensal').then(r => r.json()),
                        fetch('/api/receitas/total/anual').then(r => r.json()),
                        fetch('/api/receitas/pendentes').then(r => r.json())
                    ]);
                    
                    document.getElementById('totalRecebidoMes').textContent = formatarMoeda(mensal);
                    document.getElementById('totalAnual').textContent = formatarMoeda(anual);
                    
                    const totalPendente = pendentes.reduce((sum, r) => sum + r.valor, 0);
                    document.getElementById('totalPendente').textContent = formatarMoeda(totalPendente);
                } catch (error) {
                    console.error('Erro ao atualizar resumo:', error);
                }
            }
            
            async function salvarReceita() {
                const receita = {
                    descricao: document.getElementById('descricao').value,
                    valor: parseFloat(document.getElementById('valor').value),
                    dataRecebimento: document.getElementById('dataRecebimento').value,
                    categoria: document.getElementById('categoria').value,
                    formaPagamento: document.getElementById('formaPagamento').value,
                    cliente: document.getElementById('cliente').value,
                    numeroNotaFiscal: document.getElementById('numeroNotaFiscal').value,
                    observacoes: document.getElementById('observacoes').value,
                    recebido: document.getElementById('recebido').checked
                };
                
                try {
                    await fetch('/api/receitas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(receita)
                    });
                    
                    bootstrap.Modal.getInstance(document.getElementById('modalReceita')).hide();
                    document.getElementById('formReceita').reset();
                    carregarReceitas();
                    exibirMensagem('success', 'Receita cadastrada com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao salvar receita');
                }
            }
            
            async function marcarRecebido(id) {
                if (!confirm('Confirmar recebimento?')) return;
                
                try {
                    await fetch(`/api/receitas/${id}/marcar-recebido`, { method: 'PATCH' });
                    carregarReceitas();
                    exibirMensagem('success', 'Receita marcada como recebida!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao marcar como recebida');
                }
            }
            
            async function deletarReceita(id) {
                if (!confirm('Deseja realmente excluir esta receita?')) return;
                
                try {
                    await fetch(`/api/receitas/${id}`, { method: 'DELETE' });
                    carregarReceitas();
                    exibirMensagem('success', 'Receita excluída com sucesso!');
                } catch (error) {
                    exibirMensagem('danger', 'Erro ao excluir receita');
                }
            }
            
            document.addEventListener('DOMContentLoaded', carregarReceitas);
            
            function formatarMoeda(valor) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
            }
            
            function formatarData(data) {
                return new Date(data).toLocaleDateString('pt-BR');
            }
            
            function exibirMensagem(tipo, mensagem) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
                alertDiv.innerHTML = `${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.querySelector('.content').insertBefore(alertDiv, document.querySelector('.content').firstChild);
                setTimeout(() => alertDiv.remove(), 5000);
            }
        </script>
    </th:block>
</body>
</html>