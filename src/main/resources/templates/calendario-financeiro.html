<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <th:block th:fragment="titulo">Calendário Financeiro - AESTRON</th:block>
</head>
<body>
    <th:block th:fragment="content">

    <div class="container-fluid p-4 fade-in">
        <nav aria-label="breadcrumb" class="breadcrumb-modern">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door-fill"></i> Dashboard</a></li>
                <li class="breadcrumb-item active"><i class="bi bi-calendar3-fill"></i> Calendário Financeiro</li>
            </ol>
        </nav>

        <div class="page-header d-flex justify-content-between align-items-center flex-wrap">
            <h2><i class="bi bi-calendar3-fill"></i> Calendário Financeiro</h2>
            <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#modal">
                <i class="bi bi-plus-circle-fill"></i> Novo Evento
            </button>
        </div>

        <div class="card-modern mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <button class="btn btn-modern btn-primary-gradient" onclick="mesAnterior()">← Anterior</button>
                    <h4 id="mesAno"></h4>
                    <button class="btn btn-modern btn-primary-gradient" onclick="proximoMes()">Próximo →</button>
                </div>
                <div id="calendario"></div>
            </div>
        </div>

        <div class="card-modern">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Eventos de Hoje</h5>
            </div>
            <div class="card-body">
                <div id="eventosHoje">Carregando...</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border-radius: 15px 15px 0 0;">
                    <h5 class="modal-title"><i class="bi bi-calendar3-fill"></i> Novo Evento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form">
                        <div class="mb-3"><input type="text" class="form-control" name="titulo" placeholder="Título" required style="border-radius: 10px;"></div>
                        <div class="mb-3"><input type="date" class="form-control" name="dataEvento" required style="border-radius: 10px;"></div>
                        <div class="mb-3">
                            <select class="form-select" name="tipoEvento" required style="border-radius: 10px;">
                                <option value="VENCIMENTO">Vencimento</option>
                                <option value="RECEBIMENTO">Recebimento</option>
                                <option value="IMPOSTO">Imposto</option>
                                <option value="LEMBRETE">Lembrete</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-gradient btn-modern" onclick="salvar()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let mes = new Date().getMonth();
        let ano = new Date().getFullYear();
        const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        function mesAnterior() { mes--; if (mes < 0) { mes = 11; ano--; } carregar(); }
        function proximoMes() { mes++; if (mes > 11) { mes = 0; ano++; } carregar(); }
        async function carregar() {
            document.getElementById('mesAno').textContent = `${meses[mes]} ${ano}`;
            const res = await fetch(`/api/gestao/calendario?mes=${mes + 1}&ano=${ano}`);
            const eventos = await res.json();
            const primeiro = new Date(ano, mes, 1).getDay();
            const ultimo = new Date(ano, mes + 1, 0).getDate();
            let html = '<table class="table table-bordered"><thead><tr>';
            ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(d => html += `<th class="text-center">${d}</th>`);
            html += '</tr></thead><tbody><tr>';
            for (let i = 0; i < primeiro; i++) html += '<td></td>';
            for (let dia = 1; dia <= ultimo; dia++) {
                if ((primeiro + dia - 1) % 7 === 0 && dia !== 1) html += '</tr><tr>';
                const data = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const evs = eventos.filter(e => e.dataEvento === data);
                html += `<td class="p-2" style="min-width: 80px;"><strong>${dia}</strong>${evs.map(e => `<br><small class="badge bg-info">${e.titulo}</small>`).join('')}</td>`;
            }
            html += '</tr></tbody></table>';
            document.getElementById('calendario').innerHTML = html;
            carregarHoje();
        }
        async function carregarHoje() {
            const res = await fetch('/api/gestao/calendario/hoje');
            const eventos = await res.json();
            document.getElementById('eventosHoje').innerHTML = eventos.length > 0 ? eventos.map(e => `<div class="alert alert-info">${e.titulo}</div>`).join('') : '<p class="text-muted">Nenhum evento hoje</p>';
        }
        async function salvar() {
            const fd = new FormData(document.getElementById('form'));
            await fetch('/api/gestao/calendario', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ titulo: fd.get('titulo'), dataEvento: fd.get('dataEvento'), tipoEvento: fd.get('tipoEvento') }) });
            bootstrap.Modal.getInstance(document.getElementById('modal')).hide();
            document.getElementById('form').reset();
            carregar();
        }
        document.addEventListener('DOMContentLoaded', carregar);
    </script>
</body>
</html>

    </th:block>
</body>
</html>